# API для управления лимитами повербанков

## Обзор

API для установки индивидуальных лимитов пользователей и групповых лимитов организационных единиц. Лимиты определяют максимальное количество повербанков, которое может взять пользователь одновременно.

## Приоритет лимитов

1. **Индивидуальный лимит пользователя** - имеет наивысший приоритет
2. **Групповой лимит по умолчанию** - используется если индивидуальный лимит не задан
3. **Администраторы** - не ограничены лимитами

---

## API для индивидуальных лимитов пользователей

### PUT /api/users/{user_id}

Обновляет информацию о пользователе, включая индивидуальный лимит повербанков.

**Параметры запроса:**
```json
{
  "fio": "Иван Иванов",
  "phone_e164": "+79001234567",
  "email": "ivan@example.com",
  "status": "active",
  "powerbank_limit": 2,
  "role": "user",
  "parent_org_unit_id": 1
}
```

**Поля для установки лимита:**
- `powerbank_limit` (int) - Индивидуальный лимит повербанков для пользователя
- `individual_limit` (int) - Альтернативное название того же поля

**Валидация:**
- Лимит должен быть неотрицательным числом (0 или больше)
- Если лимит не указан, используется групповой лимит по умолчанию

**Ответ при успехе:**
```json
{
  "success": true,
  "message": "Пользователь обновлен",
  "user_id": 33,
  "updated_fields": {
    "powerbank_limit": 2,
    "fio": "Иван Иванов"
  }
}
```

**Ответ при ошибке:**
```json
{
  "success": false,
  "error": "Пользователь не найден"
}
```

**Коды ошибок:**
- `400` - Неверные параметры запроса
- `404` - Пользователь не найден
- `500` - Внутренняя ошибка сервера

**Пример запроса:**
```bash
curl -X PUT http://localhost:8000/api/users/33 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "powerbank_limit": 3,
    "fio": "Иван Иванов"
  }'
```

---

## API для групповых лимитов организационных единиц

### PUT /api/org-units/{org_unit_id}

Обновляет информацию об организационной единице, включая групповой лимит повербанков по умолчанию.

**Параметры запроса:**
```json
{
  "name": "Отдел разработки",
  "unit_type": "group",
  "adress": "Москва, ул. Примерная, 1",
  "default_powerbank_limit": 5,
  "reminder_hours": 24,
  "parent_org_unit_id": 1
}
```

**Поля для установки лимита:**
- `default_powerbank_limit` (int) - Групповой лимит повербанков по умолчанию
- `reminder_hours` (int) - Часы до отправки напоминания о возврате

**Валидация:**
- `unit_type` должен быть 'group' или 'subgroup'
- Лимит должен быть неотрицательным числом
- Часы напоминания должны быть положительным числом

**Ответ при успехе:**
```json
{
  "success": true,
  "message": "Организационная единица обновлена",
  "org_unit_id": 1,
  "updated_fields": {
    "default_powerbank_limit": 5,
    "reminder_hours": 24
  }
}
```

**Ответ при ошибке:**
```json
{
  "success": false,
  "error": "Недопустимый тип организационной единицы"
}
```

**Коды ошибок:**
- `400` - Неверные параметры запроса
- `404` - Организационная единица не найдена
- `500` - Внутренняя ошибка сервера

**Пример запроса:**
```bash
curl -X PUT http://localhost:8000/api/org-units/1 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "default_powerbank_limit": 5,
    "reminder_hours": 24,
    "name": "Отдел разработки"
  }'
```

---

## Получение информации о лимитах

### GET /api/users/{user_id}

Получает информацию о пользователе, включая текущие лимиты.

**Ответ:**
```json
{
  "success": true,
  "data": {
    "user_id": 33,
    "fio": "Иван Иванов",
    "phone_e164": "+79001234567",
    "email": "ivan@example.com",
    "status": "active",
    "role": "user",
    "powerbank_limit": 2,
    "created_at": "2024-01-15T10:30:00Z",
    "last_login_at": "2024-01-20T14:22:00Z"
  }
}
```

### GET /api/org-units/{org_unit_id}

Получает информацию об организационной единице, включая групповые лимиты.

**Ответ:**
```json
{
  "success": true,
  "data": {
    "org_unit_id": 1,
    "parent_org_unit_id": null,
    "unit_type": "group",
    "name": "Отдел разработки",
    "adress": "Москва, ул. Примерная, 1",
    "logo_url": null,
    "created_at": "2024-01-01T00:00:00Z",
    "default_powerbank_limit": 5,
    "reminder_hours": 24
  }
}
```

---

## Логика работы лимитов

### Проверка лимитов при выдаче:
- Система автоматически проверяет лимиты при каждой попытке взять повербанк
- Если пользователь превысил лимит, выдача блокируется
- Возврат повербанка уменьшает количество активных займов

### Определение эффективного лимита:
1. Если у пользователя задан `powerbank_limit` - используется индивидуальный лимит
2. Если индивидуальный лимит не задан - используется `default_powerbank_limit` из организационной единицы
3. Если пользователь - администратор - лимиты не применяются

### Примеры использования:

**Установка индивидуального лимита:**
```bash
curl -X PUT /api/users/33 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"powerbank_limit": 2}'
```

**Установка группового лимита:**
```bash
curl -X PUT /api/org-units/1 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"default_powerbank_limit": 5}'
```

**Сброс индивидуального лимита (использовать групповой):**
```bash
curl -X PUT /api/users/33 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"powerbank_limit": null}'
```

---

## Аутентификация

Все API endpoints требуют JWT токен в заголовке Authorization:
```
Authorization: Bearer YOUR_JWT_TOKEN
```

## Коды ответов

- `200` - Успешный запрос
- `400` - Неверные параметры запроса
- `401` - Не авторизован
- `403` - Доступ запрещен
- `404` - Ресурс не найден
- `500` - Внутренняя ошибка сервера
