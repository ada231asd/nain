# Исправление ошибок в системе возврата с ошибкой

## Проблемы, которые были исправлены:

### 1. AttributeError: 'ReturnPowerbankHandler' object has no attribute 'start_error_return_process'

**Проблема:** В файле `api/user_powerbank_api.py` вызывался несуществующий метод `start_error_return_process`.

**Исправление:** 
- Заменен вызов `start_error_return_process` на `handle_error_return_request`
- Обновлена структура ответа для соответствия новому API

**Файлы изменены:**
- `optimized_server2/api/user_powerbank_api.py` (строки 445, 447-456)

### 2. AttributeError: 'ReturnPowerbankHandler' object has no attribute 'handle_return_request'

**Проблема:** В файле `server.py` вызывался несуществующий метод `handle_return_request` для обработки TCP команды 0x66 (Return Power Bank).

**Исправление:**
- Добавлен новый метод `handle_return_request` в класс `ReturnPowerbankHandler`
- Метод обрабатывает TCP запросы на возврат повербанков
- Поддерживает как обычные возвраты, так и возвраты с ошибкой
- Интегрирован с существующей логикой ожидающих возвратов

**Файлы изменены:**
- `optimized_server2/handlers/return_powerbank.py` (добавлен метод `handle_return_request`)

### 3. Обновление тестового файла

**Проблема:** Тестовый файл `test_error_return_flow.py` использовал старую логику.

**Исправление:**
- Обновлен для использования правильного метода `handle_error_return_request`
- Упрощена логика тестирования

**Файлы изменены:**
- `optimized_server2/test_error_return_flow.py`

## Результат:

✅ Все ошибки исправлены
✅ API возврата с ошибкой теперь работает корректно
✅ TCP обработка возвратов интегрирована
✅ Тесты обновлены

## Проверка исправлений:

Запустите тест для проверки:
```bash
cd optimized_server2
python test_fix_verification.py
```

## Функциональность:

1. **HTTP API** - пользователи могут запросить возврат с ошибкой через веб-интерфейс
2. **TCP обработка** - станции отправляют данные о вставленных повербанках
3. **Автоматическое сопоставление** - система автоматически сопоставляет вставленные повербанки с ожидающими возврат пользователями
4. **Обновление статусов** - повербанки помечаются как имеющие системную ошибку
5. **Закрытие заказов** - активные заказы автоматически закрываются
