# API для возврата повербанка с поломкой

## Описание
API позволяет пользователям возвращать повербанки с дефектами через фронтенд. Сервер автоматически обрабатывает такие повербанки и помечает их как сломанные.

## Endpoint
```
POST /api/return-damage
```

## Авторизация
Требуется JWT токен в заголовке Authorization:
```
Authorization: Bearer <jwt_token>
```

## Параметры запроса
```json
{
    "station_id": 13,
    "description": "Повербанк не заряжается, кабель поврежден"
}
```

### Параметры:
- `station_id` (int, обязательный) - ID станции для возврата
- `description` (string, обязательный) - Описание проблемы/дефекта

## Ответы

### Успешный возврат (200 OK)
```json
{
    "success": true,
    "message": "Повербанк возвращен с поломкой и успешно обработан станцией.",
    "order_id": 123,
    "powerbank_id": 456,
    "station_id": 13,
    "powerbank_inserted": true
}
```

### Возврат с предупреждением (200 OK)
```json
{
    "success": true,
    "message": "Повербанк возвращен с поломкой, но не был обнаружен в станции. Проверьте, что повербанк вставлен правильно.",
    "order_id": 123,
    "powerbank_id": 456,
    "station_id": 13,
    "powerbank_inserted": false
}
```

### Ошибки

#### 400 Bad Request - Не указан ID станции
```json
{
    "success": false,
    "error": "Не указан ID станции"
}
```

#### 400 Bad Request - Не указано описание проблемы
```json
{
    "success": false,
    "error": "Не указано описание проблемы"
}
```

#### 404 Not Found - Станция не найдена
```json
{
    "success": false,
    "error": "Станция не найдена"
}
```

#### 500 Internal Server Error - Другие ошибки
```json
{
    "success": false,
    "error": "У вас нет активных заказов"
}
```

## Логика работы

1. **Проверка авторизации** - проверяется JWT токен
2. **Валидация данных** - проверяются обязательные параметры
3. **Проверка станции** - станция должна существовать и быть активной
4. **Проверка подключения** - станция должна быть подключена к серверу
5. **Поиск активного заказа** - у пользователя должен быть активный заказ
6. **Обновление статуса повербанка** - статус меняется на `user_reported_broken`
7. **Создание заказа на возврат** - создается новый заказ с типом `return`
8. **Обновление оригинального заказа** - статус меняется на `return_damage`
9. **Создание отчета об ошибке** - записывается информация о дефекте
10. **Отправка команды станции** - станция получает команду на принятие повербанка
11. **Ожидание вставки** - сервер ждет 10 секунд для вставки повербанка пользователем
12. **Запрос инвентаря** - запрашивается актуальный инвентарь станции
13. **Проверка вставки** - проверяется, был ли повербанк действительно вставлен
14. **Формирование ответа** - возвращается результат с информацией о статусе вставки

## Время ожидания

- **10 секунд** - время ожидания вставки повербанка пользователем
- **2 секунды** - дополнительное время для обработки ответа инвентаря
- **Общее время** - до 12 секунд на выполнение операции

## Обработка на стороне станции

После получения команды возврата станция:
1. Готовится к принятию повербанка в указанный слот
2. Пользователь вставляет повербанк в течение 10 секунд
3. Сервер запрашивает актуальный инвентарь станции
4. Сервер проверяет, был ли повербанк обнаружен в инвентаре
5. Данные о повербанке обновляются в базе данных на основе инвентаря

## Статусы повербанков

- `user_reported_broken` - повербанк сломан по отчету пользователя
- `broken` - повербанк сломан (общий статус)

## Причины списания

- `broken` - повербанк сломан
- `other` - другие причины

## Пример использования на фронтенде

```javascript
async function returnPowerbankWithDamage(stationId, description) {
    try {
        const response = await fetch('/api/return-damage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getJWTToken()}`
            },
            body: JSON.stringify({
                station_id: stationId,
                description: description
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.powerbank_inserted) {
                alert('Повербанк возвращен с поломкой и успешно обработан станцией.');
            } else {
                alert('Повербанк возвращен с поломкой, но не был обнаружен в станции. Проверьте правильность вставки.');
            }
            console.log('Order ID:', result.order_id);
            console.log('Powerbank Inserted:', result.powerbank_inserted);
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (error) {
        console.error('Ошибка запроса:', error);
        alert('Ошибка соединения с сервером');
    }
}
```

## Тестирование

Для тестирования используйте скрипт `test_damage_return.py`:

```bash
cd optimized_server2
python test_damage_return.py
```

**Важно:** Перед тестированием убедитесь, что:
1. Сервер запущен на localhost:8080
2. У вас есть валидный JWT токен
3. У пользователя есть активный заказ
4. Станция с указанным ID подключена к серверу
