# ğŸ”„ Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ğ±Ğ°Ğ½ĞºĞ°

## ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ» 3.5 Return Power Bank and Response

### ĞŸÑ€Ğ¾Ñ†ĞµÑÑ:

```
ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ²ĞµÑ€Ğ±Ğ°Ğ½Ğº Ğ² ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ
              â†“
Ğ¡Ñ‚Ğ°Ğ½Ñ†Ğ¸Ñ Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²ÑÑ‚Ğ°Ğ²ĞºÑƒ
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.5.1 Cabinet â†’ Server (Request)                     â”‚
â”‚ Ğ¡Ñ‚Ğ°Ğ½Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ¿Ğ¾Ğ²ĞµÑ€Ğ±Ğ°Ğ½ĞºĞµ:              â”‚
â”‚ - Slot, TerminalID, Level, Voltage, Current,         â”‚
â”‚   Temperature, Status, SOH                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.5.2 Server â†’ Cabinet (Response)                    â”‚
â”‚ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¸:                             â”‚
â”‚ - Slot, Result (0-5), TerminalID, Level, Voltage,    â”‚
â”‚   Current, Temperature, Status, SOH                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
Ğ¡Ñ‚Ğ°Ğ½Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Result Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾
```

---

## Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ (server):

### 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° TerminalID
```python
if not terminal_id:
    return Result = 4  # Invalid Power Bank ID
```

### 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ²ĞµÑ€Ğ±Ğ°Ğ½ĞºĞ° Ğ² Ğ‘Ğ”
```python
powerbank = await Powerbank.get_by_serial(terminal_id)

if not powerbank:
    # ĞŸĞ¾Ğ²ĞµÑ€Ğ±Ğ°Ğ½Ğº ĞĞ• ĞĞĞ™Ğ”Ğ•Ğ â†’ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ¼ 'unknown'
    powerbank = await Powerbank.create_unknown(terminal_id, org_unit_id)
    # ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼ Ğ¿Ğ¾Ğ²ĞµÑ€Ğ±Ğ°Ğ½ĞºĞ¾Ğ¼
```

### 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ»Ğ¾Ñ‚Ğ°
```python
existing = await StationPowerbank.get_by_station_and_slot(station_id, slot)

if existing:
    return Result = 5  # Slot not empty
```

### 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
```python
active_order = await Order.get_active_borrow_order(powerbank_id)

if active_order:
    # Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ·: status='borrow' â†’ status='return'
    await Order.update_order_status(order_id, 'return')
```

### 5. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² station_powerbank
```python
await StationPowerbank.add_powerbank(
    station_id, powerbank_id, slot,
    level, voltage, temperature
)
```

### 6. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¸
```python
await station.update_last_seen()
await station.update_remain_num(remain_num + 1)
```

### 7. ĞÑ‚Ğ²ĞµÑ‚ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¸
```python
return Result = 1  # Success
```

---

## ĞšĞ¾Ğ´Ñ‹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° (Result):

| ĞšĞ¾Ğ´ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | ĞšĞ¾Ğ³Ğ´Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ |
|-----|----------|-------------------|
| 0 | Failure | ĞĞ±Ñ‰Ğ¸Ğ¹ ÑĞ±Ğ¾Ğ¹ |
| **1** | **Success** | âœ… ĞŸĞ¾Ğ²ĞµÑ€Ğ±Ğ°Ğ½Ğº ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ |
| 2 | Power Bank Status Error | ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¸ |
| 3 | Duplicate Return | ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ |
| **4** | **Invalid Power Bank ID** | âš ï¸ ĞŸĞ¾Ğ²ĞµÑ€Ğ±Ğ°Ğ½Ğº ĞĞ• ĞĞĞ™Ğ”Ğ•Ğ Ğ² Ğ‘Ğ” â†’ Ğ½Ğµ Ğ¾Ñ‚Ğ´Ğ°ĞµÑ‚ÑÑ |
| **5** | **Slot not empty** | âš ï¸ Ğ¡Ğ»Ğ¾Ñ‚ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ½ÑÑ‚ |

---

## Ğ¤Ğ°Ğ¹Ğ»Ñ‹:

- `optimized_server2/handlers/return_powerbank.py` - Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº
- `optimized_server2/server.py:237-244` - Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°
- `optimized_server2/utils/packet_utils.py` - Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³/Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²

---

## Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:

### Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° `orders`:
```sql
-- Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ·Ğ°ĞºĞ°Ğ· (status='borrow')
UPDATE orders 
SET status='return', completed_at=NOW() 
WHERE order_id=X AND status='borrow'
```

### Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° `station_powerbank`:
```sql
-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ²ĞµÑ€Ğ±Ğ°Ğ½Ğº Ğ² ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ
INSERT INTO station_powerbank 
(station_id, powerbank_id, slot_number, level, voltage, temperature)
VALUES (13, 53, 3, 85, 4100, 25)
```

### Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° `station`:
```sql
-- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ²ĞµÑ€Ğ±Ğ°Ğ½ĞºĞ¾Ğ²
UPDATE station 
SET remain_num = remain_num + 1,
    last_seen = NOW()
WHERE station_id=13
```

---

**Ğ”Ğ°Ñ‚Ğ°:** 14 Ğ¾ĞºÑ‚ÑĞ±Ñ€Ñ 2025  
**Ğ’ĞµÑ€ÑĞ¸Ñ Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»Ğ°:** 3.5 Return Power Bank and Response

