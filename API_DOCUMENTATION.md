# Документация API системы управления повербанками

## Содержание
1. [API списания повербанка как утерянного](#api-списания-повербанка-как-утерянного)
2. [API возврата с ошибкой](#api-возврата-с-ошибкой)
3. [API управления лимитами пользователей](#api-управления-лимитами-пользователей)
4. [API управления лимитами групп](#api-управления-лимитами-групп)

---

## API списания повербанка как утерянного

### POST /api/admin/write-off-powerbank

Списывает повербанк у пользователя как утерянный. При этом:
- Закрывает активный заказ пользователя на этот повербанк (status='return', completed_at=NOW)
- Удаляет повербанк из всех станций
- Обновляет статус повербанка на 'written_off' и причину списания 'lost'
- Пишет запись в action_logs

**Параметры запроса:**
```json
{
  "user_id": 33,
  "powerbank_id": 53,
  "admin_user_id": 18,
  "note": "Lost by user"
}
```

**Обязательные поля:**
- `user_id` (int) - ID пользователя, у которого списывается повербанк
- `powerbank_id` (int) - ID повербанка для списания
- `admin_user_id` (int) - ID администратора, выполняющего операцию

**Опциональные поля:**
- `note` (string) - Дополнительное примечание

**Ответ при успехе:**
```json
{
  "success": true,
  "message": "Повербанк списан как утерянный",
  "powerbank_id": 53,
  "user_id": 33,
  "admin_user_id": 18,
  "status": "written_off",
  "write_off_reason": "lost"
}
```

**Ответ при ошибке:**
```json
{
  "success": false,
  "error": "Повербанк не найден"
}
```

**Коды ошибок:**
- `400` - Неверные параметры запроса
- `500` - Внутренняя ошибка сервера

---

## API возврата с ошибкой

### POST /powerbank-error-report

Создает отчет об ошибке повербанка при возврате. При этом:
- Проверяет принадлежность заказа пользователю
- Обновляет статус повербанка в зависимости от типа ошибки
- Устанавливает причину списания
- Завершает заказ

**Параметры запроса:**
```json
{
  "order_id": 123,
  "powerbank_id": 53,
  "station_id": 13,
  "user_id": 33,
  "error_type": "broken",
  "additional_notes": "Повербанк не заряжается"
}
```

**Обязательные поля:**
- `order_id` (int) - ID активного заказа
- `powerbank_id` (int) - ID повербанка
- `station_id` (int) - ID станции возврата
- `user_id` (int) - ID пользователя
- `error_type` (string) - Тип ошибки

**Опциональные поля:**
- `additional_notes` (string) - Дополнительные примечания

**Допустимые типы ошибок:**
- `"broken"` - Повербанк сломан
- `"damaged"` - Повербанк поврежден
- `"lost"` - Повербанк утерян
- `"other"` - Другая причина

**Ответ при успехе:**
```json
{
  "success": true,
  "message": "Отчет об ошибке создан",
  "order_id": 123,
  "powerbank_id": 53,
  "new_status": "user_reported_broken",
  "write_off_reason": "broken"
}
```

**Ответ при ошибке:**
```json
{
  "success": false,
  "error": "Заказ не принадлежит пользователю"
}
```

**Коды ошибок:**
- `400` - Неверные параметры запроса
- `403` - Заказ не принадлежит пользователю
- `404` - Заказ, повербанк или станция не найдены
- `500` - Внутренняя ошибка сервера

---

## API управления лимитами пользователей

### PUT /api/users/{user_id}

Обновляет информацию о пользователе, включая индивидуальный лимит повербанков.

**Параметры запроса:**
```json
{
  "fio": "Иван Иванов",
  "phone_e164": "+79001234567",
  "email": "ivan@example.com",
  "status": "active",
  "powerbank_limit": 2,
  "role": "user",
  "parent_org_unit_id": 1
}
```

**Поля для обновления лимита:**
- `powerbank_limit` (int) - Индивидуальный лимит повербанков для пользователя
- `individual_limit` (int) - Альтернативное название того же поля

**Валидация:**
- Лимит должен быть неотрицательным числом
- Если лимит не указан или равен null, используется групповой лимит по умолчанию

**Ответ при успехе:**
```json
{
  "success": true,
  "message": "Пользователь успешно обновлен",
  "data": {
    "user_id": 33,
    "fio": "Иван Иванов",
    "phone_e164": "+79001234567",
    "email": "ivan@example.com",
    "role": "user",
    "parent_org_unit_id": 1,
    "individual_limit": 2
  }
}
```

**Ответ при ошибке:**
```json
{
  "success": false,
  "error": "Лимит повербанков не может быть отрицательным"
}
```

**Коды ошибок:**
- `400` - Неверные параметры запроса
- `404` - Пользователь не найден
- `500` - Внутренняя ошибка сервера

---

## API управления лимитами групп

### PUT /api/org-units/{org_unit_id}

Обновляет информацию об организационной единице, включая лимит повербанков по умолчанию.

**Параметры запроса:**
```json
{
  "name": "Отдел продаж",
  "unit_type": "group",
  "parent_org_unit_id": null,
  "adress": "Москва, ул. Примерная, 1",
  "logo_url": "https://example.com/logo.png",
  "default_powerbank_limit": 3,
  "reminder_hours": 24
}
```

**Поля для обновления лимитов:**
- `default_powerbank_limit` (int) - Лимит повербанков по умолчанию для группы
- `reminder_hours` (int) - Через сколько часов отправлять напоминание о возврате

**Валидация:**
- `unit_type` должен быть 'group' или 'subgroup'
- Лимит должен быть неотрицательным числом
- Часы напоминания должны быть положительным числом

**Ответ при успехе:**
```json
{
  "success": true,
  "message": "Организационная единица обновлена"
}
```

**Ответ при ошибке:**
```json
{
  "success": false,
  "error": "Недопустимый тип организационной единицы"
}
```

**Коды ошибок:**
- `400` - Неверные параметры запроса
- `404` - Организационная единица не найдена
- `500` - Внутренняя ошибка сервера

---

## Логика работы лимитов

### Приоритет лимитов:
1. **Индивидуальный лимит пользователя** (`app_user.powerbank_limit`) - имеет наивысший приоритет
2. **Групповой лимит по умолчанию** (`org_unit.default_powerbank_limit`) - используется если индивидуальный лимит не задан
3. **Администраторы** - не ограничены лимитами

### Проверка лимитов при выдаче:
- Система автоматически проверяет лимиты при каждой попытке взять повербанк
- Если пользователь превысил лимит, выдача блокируется
- Возврат повербанка уменьшает количество активных займов

### Примеры использования:

**Установка индивидуального лимита:**
```bash
curl -X PUT /api/users/33 \
  -H "Content-Type: application/json" \
  -d '{"powerbank_limit": 2}'
```

**Установка группового лимита:**
```bash
curl -X PUT /api/org-units/1 \
  -H "Content-Type: application/json" \
  -d '{"default_powerbank_limit": 3}'
```

**Списание утерянного повербанка:**
```bash
curl -X POST /api/admin/write-off-powerbank \
  -H "Content-Type: application/json" \
  -d '{"user_id": 33, "powerbank_id": 53, "admin_user_id": 18}'
```

**Отчет об ошибке:**
```bash
curl -X POST /powerbank-error-report \
  -H "Content-Type: application/json" \
  -d '{"order_id": 123, "powerbank_id": 53, "station_id": 13, "user_id": 33, "error_type": "broken"}'
```
